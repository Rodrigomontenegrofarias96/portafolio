# azure-pipelines.yml
# Configuración para activarse cuando se hace merge hacia main
trigger:
  branches:
    include:
      - main  # Se activa cuando se hace push/merge a main
  paths:
    exclude:
      - README.md
      - docs/*

# Desactivar PRs (solo queremos que se active en merge completado)
pr: none

pool:
  name: Default

variables:
  # === IMPORTANTE: Variable Group desde Library ===
  - group: variable

  # Variables del sistema
  - name: system.debug
    value: false

  # Variables del proyecto
  - name: deployTag
    value: $(Build.BuildNumber)
  - name: branchName
    value: $(Build.SourceBranchName)
  - name: commitMessage
    value: $(Build.SourceVersionMessage)
  - name: commitAuthor
    value: $(Build.RequestedFor)
  - name: buildReason
    value: $(Build.Reason)

stages:
  - stage: StatusUpdate
    displayName: 'Update Merge Status'
    jobs:
      - job: StatusJob
        displayName: 'Merge Status Tracking'
        steps:
          - bash: |
              set -euo pipefail
              echo "=== MERGE A MAIN DETECTADO ==="
              echo "Branch: $(branchName)"
              echo "Build Reason: $(buildReason)"
              echo "Commit Message: $(commitMessage)"
              echo "Autor: $(commitAuthor)"
              echo "Build Number: $(Build.BuildNumber)"
              echo "Commit ID: $(Build.SourceVersion)"
              echo "Timestamp: $$(date)"
              echo "================================"

              # Registrar merge en log de estatus
              echo "$$(date): MERGE to main - Build $(Build.BuildNumber) - Author: $(commitAuthor) - Commit: $(Build.SourceVersion)" >> merge_status.log
            displayName: 'Log Merge Status'

  - stage: Build
    displayName: 'Build and Package'
    dependsOn: StatusUpdate
    jobs:
      - job: BuildJob
        displayName: 'Build Job'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '16.x'
            displayName: 'Install Node.js'

          - bash: |
              set -euo pipefail
              npm ci
            displayName: 'Install dependencies'

          - bash: |
              set -euo pipefail
              echo "=== CONFIGURANDO VARIABLES DE ENTORNO ==="

              echo "Verificando variables del pipeline..."
              if [ -z "${REACT_APP_EMAILJS_SERVICE_ID:-}" ]; then
                echo "ERROR: REACT_APP_EMAILJS_SERVICE_ID no está configurada"
                exit 1
              fi

              if [ -z "${REACT_APP_EMAILJS_TEMPLATE_ID:-}" ]; then
                echo "ERROR: REACT_APP_EMAILJS_TEMPLATE_ID no está configurada"
                exit 1
              fi

              if [ -z "${REACT_APP_EMAILJS_PUBLIC_KEY:-}" ]; then
                echo "ERROR: REACT_APP_EMAILJS_PUBLIC_KEY no está configurada"
                exit 1
              fi

              echo "Todas las variables de EmailJS están configuradas ✓"

              # Crear archivo .env SIN heredoc (para que no marque rojo)
              echo "Creando archivo .env..."
              printf "REACT_APP_EMAILJS_SERVICE_ID=%s\nREACT_APP_EMAILJS_TEMPLATE_ID=%s\nREACT_APP_EMAILJS_PUBLIC_KEY=%s\n" \
                "$REACT_APP_EMAILJS_SERVICE_ID" \
                "$REACT_APP_EMAILJS_TEMPLATE_ID" \
                "$REACT_APP_EMAILJS_PUBLIC_KEY" > .env

              echo "Archivo .env creado exitosamente"
              echo "Verificando contenido del .env (sin mostrar valores sensibles):"
              echo "Variables encontradas en .env:"
              cut -d= -f1 .env

              echo "=== INICIANDO BUILD ==="
            displayName: 'Configure Environment Variables'
            env:
              REACT_APP_EMAILJS_SERVICE_ID: $(REACT_APP_EMAILJS_SERVICE_ID)
              REACT_APP_EMAILJS_TEMPLATE_ID: $(REACT_APP_EMAILJS_TEMPLATE_ID)
              REACT_APP_EMAILJS_PUBLIC_KEY: $(REACT_APP_EMAILJS_PUBLIC_KEY)

          - bash: |
              set -euo pipefail
              echo "Ejecutando npm run build con variables de entorno explícitas..."

              if [ ! -f .env ]; then
                echo "ERROR: Archivo .env no encontrado"
                exit 1
              fi

              echo "Node version: $$(node --version)"
              echo "NPM version: $$(npm --version)"

              npm run build

              if [ ! -d "build" ]; then
                echo "ERROR: Directorio build no fue creado"
                exit 1
              fi

              echo "Build completado exitosamente ✓"
              echo "Contenido del directorio build:"
              ls -la build/
            displayName: 'Build React Project'
            env:
              REACT_APP_EMAILJS_SERVICE_ID: $(REACT_APP_EMAILJS_SERVICE_ID)
              REACT_APP_EMAILJS_TEMPLATE_ID: $(REACT_APP_EMAILJS_TEMPLATE_ID)
              REACT_APP_EMAILJS_PUBLIC_KEY: $(REACT_APP_EMAILJS_PUBLIC_KEY)
              CI: true

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/build'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/build.zip'
              replaceExistingArchive: true
            displayName: 'Archive build files'

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'drop'
            displayName: 'Publish artifacts'

  - stage: Deploy
    displayName: 'Deploy to Production'
    dependsOn: Build
    jobs:
      - job: DeployJob
        displayName: 'Deploy Job'
        steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(System.ArtifactsDirectory)'
            displayName: 'Download build artifacts'

          - bash: |
              set -euo pipefail

              if [ -z "${NETLIFY_AUTH_TOKEN:-}" ]; then
                echo "ERROR: NETLIFY_AUTH_TOKEN no está configurada"
                exit 1
              fi

              if [ -z "${NETLIFY_SITE_ID:-}" ]; then
                echo "ERROR: NETLIFY_SITE_ID no está configurada"
                exit 1
              fi

              if [ ! -f "$(System.ArtifactsDirectory)/drop/build.zip" ]; then
                echo "ERROR: Archivo build.zip no encontrado"
                exit 1
              fi

              echo "Todas las variables de Netlify están configuradas ✓"
              echo "Archivo build.zip encontrado ✓"

              DEPLOY_TITLE="Production Deploy $(deployTag) - Merged to main"
              echo "Iniciando despliegue de producción después de merge..."

              DEPLOY_RESPONSE=$(curl -s -X POST "https://api.netlify.com/api/v1/sites/$(NETLIFY_SITE_ID)/deploys" \
                -H "Authorization: Bearer $(NETLIFY_AUTH_TOKEN)" \
                -F "file=@$(System.ArtifactsDirectory)/drop/build.zip" \
                -F "title=$DEPLOY_TITLE")

              echo "Respuesta de despliegue: $DEPLOY_RESPONSE"

              DEPLOY_ID=$(echo "$DEPLOY_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

              if [ -z "$DEPLOY_ID" ]; then
                echo "Error: No se pudo obtener el ID del despliegue"
                echo "Respuesta completa: $DEPLOY_RESPONSE"
                exit 1
              fi

              echo "ID del despliegue: $DEPLOY_ID"

              echo "Esperando que el despliegue se complete..."
              sleep 30

              echo "Ejecutando limpieza de caché y retry..."
              RETRY_RESPONSE=$(curl -s -X POST "https://api.netlify.com/api/v1/sites/$(NETLIFY_SITE_ID)/deploys/$DEPLOY_ID/retry" \
                -H "Authorization: Bearer $(NETLIFY_AUTH_TOKEN)" \
                -H "Content-Type: application/json" \
                -d '{"clear_cache":true}')

              echo "Respuesta de retry: $RETRY_RESPONSE"

              if echo "$RETRY_RESPONSE" | grep -q '"state":"enqueued"'; then
                echo "Despliegue de producción iniciado exitosamente después del merge ✓"
              else
                echo "Advertencia: Verificar estado del despliegue en Netlify dashboard"
                echo "URL del dashboard: https://app.netlify.com/sites/$(NETLIFY_SITE_ID)/deploys"
              fi
            displayName: 'Deploy Production After Merge'
            env:
              NETLIFY_AUTH_TOKEN: $(NETLIFY_AUTH_TOKEN)
              NETLIFY_SITE_ID: $(NETLIFY_SITE_ID)

  - stage: PostDeploy
    displayName: 'Post Merge Status'
    dependsOn: Deploy
    jobs:
      - job: FinalStatus
        displayName: 'Final Status Update'
        steps:
          - bash: |
              set -euo pipefail
              echo "=== MERGE COMPLETADO ==="
              echo "Branch: $(branchName)"
              echo "Commit: $(Build.SourceVersion)"
              echo "Autor: $(commitAuthor)"
              echo "Build: $(Build.BuildNumber)"
              echo "Deploy completado a producción"
              echo "Timestamp: $$(date)"
              echo "Status: PRODUCCIÓN ACTUALIZADA ✓"
              echo "========================"

              echo "$$(date): MERGE COMPLETED - Build $(Build.BuildNumber) - Production deployed successfully" >> merge_status.log
            displayName: 'Final Merge Status'
